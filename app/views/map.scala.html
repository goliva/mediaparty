<!DOCTYPE unspecified PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>MercadoLibre workshop - MediaParty</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="assets/pure.css" rel="stylesheet" media="screen">
    <link href="assets/map.css" rel="stylesheet" media="screen">
  </head>
  <body>
    <div class="header pure-u-1">
        <div class="logo">
            <img src="http://static.mlstatic.com/org-img/commons/logo-mercadolibre-new.png"/>
        </div>
        <div class="data">
           <div>User: @nickname</div>
           <div>Words:
            @for(hash <- hashes.split(" ")) {
                <span class="label">@hash</span>
            }</div>
        </div>
        <div class="clear"></div>
    </div>
    <div class="map-container pure-u-3-4">
        <div id="map"></div>
    </div>
    <div class="pure-u-1-4-over">
        <div class="profile-tweets">
            <p class="title">
            Tweets
            </p>
            <ul id="tweets"></ul>
        </div>
        <div class="clear"></div>
    </div>
    <li id="tweet"><img id="img" class="avatar" alt="" />
      <div class="tweet-content">
        <h5 class="tweet-user"  id="user">
        </h5>
        <p id="text">
        </p>
      </div>
    </li>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script>
    	var myVar;
		var stack = [];
		var stackMarkers = [];

    	function renderStack() {
    		$('#tweets').html("");
    		for (var i = 0; i < stackMarkers.length; i++) {
    			stackMarkers[i].setMap(null);
    		}
    		for (var i = 0; i < stack.length; i++) {
    			var json = JSON.parse(stack[i]);
    			var myLatLng = {lat: json.coordinates[1], lng: json.coordinates[0]};
    			var marker = new google.maps.Marker({
    			    position: myLatLng,
    			    map: map,
    			    title: 'tweet'
    			  });
    			stackMarkers[i] = marker;
    			var tweet = $('#tweet').clone();
    			tweet.children('#img').attr('src',json.tweet.img);
    			tweet.children('#text').html(json.tweet.text);
    			tweet.children('#user').html(json.tweet.user);
    			$('#tweets').append(tweet);

    		}
    	}

		function recursivo() {
    	    myVar = setInterval(call, 3000);
    	}

    	function call() {
    		$.ajax({
   			  dataType: "json",
   			  url: "/get-tweets/@nickname",
   			  success: function (data) {
   				  if(data.dots.length > 0){
   					if(stack.length >= 200){
   					  	for (var i = 0; i < data.dots.length; i++) {
   							console.log("borrar");
   					  		stack.shift();
   						}
   					}
   					for (var i = 0; i < data.dots.length; i++) {
   						stack.push(data.dots[i]);
   					}
   					renderStack();
   				  }
   			  }
   			});
    	}



    	var map;
    	function initMap() {
    	  map = new google.maps.Map(document.getElementById('map'), {
    	    center: {lat: 0, lng: 0},
    	    zoom: 3
    	  });
    	}
    	recursivo();
    </script>
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQ1crnrU5pOqSuN1uWiz_hucBdq4EVzBM&signed_in=true&libraries=visualization&callback=initMap">
    </script>

  </body>
</html>
